# mlux 完成度評価 — less / glow / 他ツールとの詳細比較

2026-02-27

## 根本的な設計思想の違い

まず認識すべきは、mlux が他のどのツールとも**根本的に異なるアプローチ**を取っていることである。

| ツール | レンダリング方式 | 出力 |
|--------|------------------|------|
| **less** | レンダリングなし（生テキスト） | 文字セル |
| **glow** | ANSI エスケープコード | 文字セル（装飾付き） |
| **bat** | シンタックスハイライト | 文字セル（装飾付き） |
| **mdcat** | ANSI + 画像プロトコル | 文字セル + インライン画像 |
| **mlux** | **Typst 組版エンジン → PNG** | **ピクセルレンダリング** |

glow や bat が「ターミナルの文字セルをどう装飾するか」という問題を解いているのに対し、mlux は「プロフェッショナルな組版結果をターミナルに表示する」という、一段上の問題を解いている。これは PDF ビューアに近い。

---

## 各ツールの概要

### less (Unix pager)

- レンダリングなし。Markdown をプレーンテキストとして表示
- 双方向スクロール、正規表現検索（`/`, `?`, `&`）、マーク、複数ファイル対応
- `F` キーで `tail -f` 相当のフォローモード
- パイプ入力 (`command | less`) に完全対応
- LESSOPEN/LESSCLOSE による入力プリプロセッサ拡張
- ほぼ全てのターミナルで動作。数十年の安定性

### glow (charmbracelet/glow)

- goldmark (CommonMark 準拠) でパース → Glamour で ANSI レンダリング
- **対応要素:** 見出し、段落、強調、取り消し線、インラインコード、フェンスコードブロック（chroma によるシンタックスハイライト）、引用、リスト（タスクリスト含む）、テーブル、リンク、水平線、定義リスト
- **非対応:** 画像（alt テキストのみ表示）、数式/LaTeX、Mermaid
- TUI モード（ファイルブラウザ）+ ページャモード
- `/` で前方検索、`n`/`N` で結果巡回
- テーマ: `ascii`, `auto`, `dark`, `dracula`, `tokyo-night`, `light`, `notty`, `pink` + カスタム JSON スタイルシート
- ANSI のみ（Kitty/Sixel 不要）、ほぼ全ターミナルで動作

### bat (sharkdp/bat)

- Markdown をレンダリングしない。ソースコードとしてシンタックスハイライト表示
- syntect (Sublime Text 定義) による 166+ 言語対応
- 行番号、Git diff インジケータ、自動ページング
- less をバックエンドページャとして使用可能

### mdcat (swsnr/mdcat) — 2025年1月アーカイブ済み

- ANSI レンダリング + iTerm2/Kitty/Sixel による画像インライン表示
- OSC 8 ハイパーリンク、シンタックスハイライト
- ページャ機能なし（`cat` 相当、パイプで less に渡す）
- **メンテナンス終了**

### mcat (Skardyy/mcat)

- 画像・動画・PDF・DOCX・Markdown のマルチフォーマットビューア
- Sixel / Kitty Graphics Protocol による画像表示
- 比較的新しいプロジェクト

---

## mlux の現在の機能セット

### Markdown 変換 (convert.rs)

**対応ブロック要素:**
- 見出し (h1-h6)
- 段落（ソフト改行・ハード改行）
- フェンスコードブロック（言語指定付き）
- 順序なしリスト / 順序付きリスト
- 引用（ネスト対応、深さ上限 10）
- テーブル（列数・セル内容）
- 水平線

**対応インライン要素:**
- 太字、イタリック、取り消し線
- インラインコード（バッククォート含むケースは `#raw()` 関数使用）
- リンク（空 URL は平文に降格）
- Typst 特殊文字エスケープ (`#*_<>@$\/~()[]`)

**非対応:**
- 画像
- タスクリスト / チェックボックス
- 脚注
- 定義リスト
- 上付き / 下付き文字
- インライン HTML
- YAML フロントマター

### レンダリング (render.rs, world.rs)

- Typst 0.14 組版エンジンによる PDF 品質のレンダリング
- 設定可能パラメータ: width (660pt), PPI (144), strip-height (500pt), theme
- フォント: IPAGothic → Noto Sans CJK JP → Noto Sans
- テーマ: Typst ソースファイル（Catppuccin Mocha 同梱）

### ターミナルビューア (viewer.rs, strip.rs)

**表示:**
- Kitty Graphics Protocol によるピクセルレンダリング
- 6 カラムサイドバーに行番号表示
- ステータスバー（ファイル名、スクロール位置、パーセンテージ）

**ナビゲーション (vim/less ライク):**

| キー | 動作 |
|------|------|
| `j` / `↓` | 下スクロール（`Nj` で N ステップ） |
| `k` / `↑` | 上スクロール（`Nk` で N ステップ） |
| `d` | 半ページ下（`Nd` 対応） |
| `u` | 半ページ上（`Nu` 対応） |
| `g` | 先頭へ / `Ng` で N 行目へジャンプ |
| `G` | 末尾へ / `NG` で N 行目へジャンプ |
| `y` | 行ヤンク（`Ny` で N 行目のコードをコピー） |
| `Y` | ブロックヤンク（`NY` で N 番目のブロック全体をコピー） |
| `Esc` | 数値入力キャンセル |
| `q` / `Ctrl+C` | 終了 |

**アーキテクチャ:**
- ストリップベース遅延レンダリング（ドキュメント全体を 1 回コンパイル → フレームツリーを垂直ストリップに分割）
- 可視ストリップのみ PNG 化、LRU キャッシュ（前後 ±4 ストリップ）
- プリフェッチワーカー（前方 2 + 後方 1 ストリップ先行レンダリング）
- ピークメモリはストリップサイズに比例（ドキュメントサイズに非依存）
- フレームバジェット 32ms (~30fps)
- ターミナルリサイズ対応（ドキュメント再構築、スクロール位置保持）

### CLI

```bash
# ビューアモード（デフォルト）
mlux <input.md> [--theme catppuccin]

# PNG レンダリング
mlux render <input.md> -o <output.png> [--width 660pt] [--ppi 144] [--strip-height 500] [--theme catppuccin]

# デバッグ: フレームツリーダンプ
mlux render <input.md> --dump
```

### テスト・堅牢性

- ユニットテスト 20 件 (convert.rs) + 統合テスト 17 件 = 計 37 テスト
- ファズテスト 2 ターゲット (`fuzz_convert`, `fuzz_pipeline`)
- 発見・修正済みバグ 3 件（空 URL リンク、深い引用ネスト、リスト内ルールのソースマップ重複）
- RawGuard パターンによるパニック時のターミナル状態復元

---

## mlux が明確に優位な領域

### 1. タイポグラフィ品質 — 圧倒的

Typst エンジンによる組版は ANSI ベースのツールでは原理的に不可能なレベル:
- カーニング、リガチャ、プロポーショナルフォント
- 両端揃え（ジャスティフィケーション）
- 日本語の禁則処理・行分割
- 見出し・本文・コードのフォントサイズの正確な制御
- テーブルのピクセル精度レイアウト

glow のテーブルは文字罫線 (`─│┌┐`) で描画されるため、セル内テキストの折り返しやアラインメントに限界がある。mlux の Typst テーブルは PDF 品質。

### 2. 日本語（CJK）サポート

IPAGothic + Noto Sans CJK JP のフォントチェーン、Typst の CJK 行分割アルゴリズムにより、日本語ドキュメントの表示品質は glow を大きく上回る。glow はワードラップが英語中心で、CJK の行分割はターミナルエミュレータ任せ。

### 3. メモリ効率のアーキテクチャ

ストリップベースの遅延レンダリング + LRU キャッシュは、巨大ドキュメントのスケーラビリティを保証する優れた設計。less の「ファイル全体を読まない」設計哲学と同じ精神を、ピクセルレンダリングという重い処理に対して実現している。

### 4. Yank 機能の精密さ

ソースマッピング（Markdown バイト範囲 → Typst バイト範囲）による行単位・ブロック単位のヤンクはユニークな機能。コードブロックの特定行をピクセル座標からソースコード行に逆引きして OSC 52 でクリップボードにコピーする — これは他のどのツールにもない。

### 5. テーマの拡張性

glow も JSON スタイルシートで高いカスタマイズ性を持つが、mlux のテーマは Typst ソースそのものなので、Typst の全機能（数式、図形、カスタムレイアウト）が使える潜在力がある。

---

## mlux が劣る領域

### 1. 検索機能の欠如 — 最大の弱点

| ツール | 検索 | 方式 |
|--------|------|------|
| less | `/pattern`, `?pattern`, `&pattern` | 正規表現、ハイライト、フィルタ |
| glow | `/` で前方検索、`n`/`N` | テキスト検索 |
| **mlux** | **なし** | — |

ページャとしての基本機能である検索がないのは、実用上の大きなギャップ。ピクセルレンダリングのため実装は自明ではないが（OCR ではなくソースマッピングの逆引きが必要）、ヤンク機能のソースマップ基盤は既にあるので技術的には実現可能。

### 2. ターミナル互換性

| ツール | 要求プロトコル | 対応ターミナル |
|--------|--------------|---------------|
| less | 基本 ANSI | ほぼ全て |
| glow | ANSI + TrueColor | ほとんど全て |
| **mlux** | **Kitty Graphics Protocol** | **Kitty, Ghostty, WezTerm のみ** |

設計上のトレードオフであり「弱点」とは言い切れないが、ユーザベースを大幅に制限する。Sixel フォールバックがあれば xterm/foot/mintty 等にも広がる。

### 3. 画像サポートなし

Markdown の `![alt](url)` を処理していない。ただし glow も画像は表示できず、画像を表示できるのは mdcat（アーカイブ済み）と mcat 程度。業界全体の課題であり mlux 固有の弱点ではない。

### 4. コードブロックのシンタックスハイライト

glow は chroma による言語別カラーリングを行い、bat は syntect（Sublime 定義）でハイライトする。mlux は Typst の `raw` ブロックを使っているが、Typst 0.14 はシンタックスハイライトに対応しているため、言語指定を渡せば実現できるはず。未活用の能力。

### 5. パイプ入力の非対応

less の最大の強みの一つは `command | less` のパイプ対応。mlux がファイル引数のみなのは、ページャとしての汎用性を下げている。

---

## 完成度スコア

```
                    less     glow     mlux
                    ────     ────     ────
組版品質             ✗        ★★       ★★★★★
Markdown 対応範囲    ✗        ★★★★     ★★★
ナビゲーション       ★★★★★    ★★★      ★★★★
検索                ★★★★★    ★★★      ✗
ターミナル互換性     ★★★★★    ★★★★     ★★
テーマ              ✗        ★★★★     ★★★
メモリ効率          ★★★★★    ★★★      ★★★★
コードハイライト     ✗        ★★★★     ★
堅牢性 / テスト      ★★★★★    ★★★★     ★★★★
日本語対応          ★★       ★★       ★★★★★
ヤンク / コピー      ★★       ★★       ★★★★★
```

---

## 結論

mlux は「ターミナルの文字セルの限界内で頑張る」という従来の Markdown ビューアの発想を完全に超え、**ターミナル上の PDF ビューア**という新しいカテゴリを切り開いている。Typst 組版 + Kitty Graphics + ストリップ遅延レンダリングという技術スタックの選択は野心的でありながら、実装は堅実。

**完成度は高い。** 37 テスト + ファズテスト、全既知バグ修正済み、vim ライクなナビゲーション、ソースマッピングベースのヤンク、メモリ効率の良いアーキテクチャ — 個人プロジェクトとしては明らかにプロダクション品質に達している。

ただし **ページャとしての完成度** と **組版ビューアとしての完成度** は区別が必要:

- 組版ビューアとして: **90%** — Typst の能力をよく引き出しており、ストリップベースレンダリングは秀逸
- ページャとして: **70%** — 検索がなく、パイプ入力非対応で、less の代替としては使えない場面がある
- Markdown レンダラとして: **80%** — 画像・タスクリスト・脚注が未対応だが、主要要素はカバー

### 次に最もインパクトのある改善候補

1. **`/` 検索の実装** — ソースマップの逆引き基盤は既にある。ビジュアル行からソーステキストを取得 → テキスト検索 → 該当行へのジャンプ、という流れは現在のアーキテクチャの延長線上にある
2. **シンタックスハイライト** — Typst の `raw(lang: "rust")` に言語パラメータを渡すだけで実現可能な可能性が高い
3. **パイプ入力対応** — stdin からの読み取りを追加
4. **Sixel フォールバック** — 対応ターミナルの大幅な拡大
